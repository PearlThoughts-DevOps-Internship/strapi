name: Deployment for Strapi API

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-20.04
    
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
        
      - name: Setting up AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.MAHESHR_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.MAHESH_AWS_SECRET_KEY_ID }}
          aws-region: us-west-2 

      - name: Setting up Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init
        working-directory: ./Terraform

      - name: Terraform Apply
        env:
          HOST: ${{ secrets.MAHESHR_HOST }}
          PORT: ${{ secrets.MAHESHR_PORT }}
          APP_KEYS: ${{ secrets.MAHESHR_APP_KEYS }}
          API_TOKEN_SALT: ${{ secrets.MAHESHR_API_TOKEN_SALT }}
          ADMIN_JWT_SECRET: ${{ secrets.MAHESHR_ADMIN_JWT_SECRET }}
          TRANSFER_TOKEN_SALT: ${{ secrets.MAHESHR_TRANSFER_TOKEN_SALT }}
          DATABASE_CLIENT: ${{ secrets.MAHESHR_DATABASE_CLIENT }}
          DATABASE_FILENAME: ${{ secrets.MAHESHR_DATABASE_FILENAME }}
          JWT_SECRET: ${{ secrets.MAHESHR_JWT_SECRET }}
        run: terraform apply -var MAHESHR_HOST=${{ secrets.MAHESHR_HOST }} -var MAHESHR_PORT=${{ secrets.MAHESHR_PORT }} -var MAHESHR_APP_KEYS=${{ secrets.MAHESHR_APP_KEYS }} -var MAHESHR_API_TOKEN_SALT=${{ secrets.MAHESHR_API_TOKEN_SALT }} -var MAHESHR_ADMIN_JWT_SECRET=${{ secrets.MAHESHR_ADMIN_JWT_SECRET }} -var MAHESHR_TRANSFER_TOKEN_SALT=${{ secrets.MAHESHR_TRANSFER_TOKEN_SALT }} -var MAHESHR_DATABASE_CLIENT=${{ secrets.MAHESHR_DATABASE_CLIENT }} -var MAHESHR_DATABASE_FILENAME=${{ secrets.MAHESHR_DATABASE_FILENAME }} -var MAHESHR_JWT_SECRET=${{ secrets.MAHESHR_JWT_SECRET }} -var-file "dev.tfvars" -auto-approve
        working-directory: ./Terraform
